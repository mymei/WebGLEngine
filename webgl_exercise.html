<html ng-app='WebGLEngine'>

<script type="text/javascript" src="lib/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="lib/gl-matrix.js"></script>
<script type="text/javascript" src="lib/webgl-debug.js"></script>
<script type="text/javascript" src="lib/xml2json.js"></script>
<script type="text/javascript" src="lib/msgpack.js"></script>
<script type="text/javascript" src="lib/angular.min.js"></script>

<script type="text/javascript" src="src/common/SWE_base.js"></script>
<script type="text/javascript" src="src/common/serialization.js"></script>
<script type="text/javascript" src="src/common/keyListener.js"></script>
<script type="text/javascript" src="src/common/buttonListener.js"></script>

<script type="text/javascript" src="src/collada_parser/common.js"></script>
<script type="text/javascript" src="src/collada_parser/scene.js"></script>
<script type="text/javascript" src="src/collada_parser/animation.js"></script>
<script type="text/javascript" src="src/collada_parser/skin.js"></script>
<script type="text/javascript" src="src/collada_parser/geometry.js"></script>
<script type="text/javascript" src="src/collada_parser/mesh.js"></script>
<script type="text/javascript" src="src/collada_parser/polygon.js"></script>
<script type="text/javascript" src="src/collada_parser/meshdata.js"></script>
<script type="text/javascript" src="src/collada_parser/buffer.js"></script>
<script type="text/javascript" src="src/collada_parser/controller.js"></script>
<script type="text/javascript" src="src/collada_parser/asset.js"></script>

<script type="text/javascript" src="src/webgl/webgl_core.js"></script>
<script type="text/javascript" src="src/webgl/drawingelement.js"></script>
<script type="text/javascript" src="src/webgl/colladaelement.js"></script>
<script type="text/javascript" src="src/webgl/planeelement.js"></script>
<script type="text/javascript" src="src/webgl/primitive.js"></script>

<script type="text/javascript" src="src/scene/sceneNode.js"></script>
<script type="text/javascript" src="src/scene/sceneCamera.js"></script>
<script type="text/javascript" src="src/scene/sceneObject.js"></script>

<div ng-controller="mainCtrl">

<canvas id="canvas" width='400' height='300' style="background-color:rgba(0, 0, 0, 0.5)" ng-click="triggerAnimation()" ng-mousemove="handleMouseMove($event)" ng-mousedown="mousedown($event)"></canvas>

<script type="text/javascript">

	var canvas = document.getElementById("canvas"), gl = canvas.getContext('experimental-webgl');

	gl.clearColor(0.15, 0.15, 1, 0.5);
	gl.enable(gl.DEPTH_TEST);


	// var eagleMesh = createPackedObject('./eagle.mbf');
	var alienMesh = createPackedObject('./alien.mbf');
	// var gonMesh = createPackedObject('./gon.mbf');
	var avatarMesh = createPackedObject('./avatar.mbf');

	// var eagleAni = createPackedObject('./eagle.ani');
	var alienAni = createPackedObject('./alien.ani');
	var avatarAni = createPackedObject('./avatar.ani');

	var oReq = new XMLHttpRequest();
	oReq.open("GET", "./cube2.mbf", true);
	oReq.responseType = "arraybuffer";

	oReq.onload = function (oEvent) {
		var arrayBuffer = oReq.response;
		if (arrayBuffer) {
			var byteArray = new Uint8Array(arrayBuffer);

		}
	};

	oReq.send(null);

	function unpack_float(data) {
		var uint32 =
		((data.charCodeAt(0)  * 256 +
			data.charCodeAt(1)) * 256 +
		data.charCodeAt(2)) * 256 +
		data.charCodeAt(3);

		var sign = uint32 >> 31;
		var exp  = ((uint32 >> 23) & 0xff) - 127;
		var fraction = ( uint32 & 0x7fffff ) | 0x800000;
		return (sign == 0 ? 1 : -1) *
		fraction * Math.pow(2, exp - 23);
	}

	function pack_int32(num){
        return String.fromCharCode((num >>> 24) & 0xff,
                (num & 0x00ff0000) >>> 16,
                (num & 0x0000ff00) >>> 8,
                (num & 0x000000ff));
    }

	function pack_float(num){
        var sign = 0;
        if(num < 0){
            sign = 1;
            num = -num;
        }
        var exp  = Math.floor(Math.log(num) / Math.LN2);
        var frac0 = num / Math.pow(2, exp) - 1;
        var frac1 = Math.floor(frac0 * Math.pow(2, 23));
        var h32 = (sign << 31) | ((exp+127) << 23) | frac1 & 0x7fffff;
        return pack_int32(h32);
    }

    console.log(unpack_float(pack_float(0.99999)));


	   //  p.unpack_float = function(){
    //     var uint32 = this.unpack_uint32();
    //     var sign = uint32 >> 31;
    //     var exp  = ((uint32 >> 23) & 0xff) - 127;
    //     var fraction = ( uint32 & 0x7fffff ) | 0x800000;
    //     return (sign == 0 ? 1 : -1) *
    //         fraction * Math.pow(2, exp - 23);
    // }

	console.log(MessagePack.pack({"compact":true,"schema":[0.12, 0.13, 0.14, 0.15]}));

	var scene = new SWE.Node;

	// var eagle = new SWE.SceneObject('resources/my_shader2.fs', eagleMesh);
	// scene.add(eagle);
	// vec3.set(eagle.position, 150, 0, 0);
	// eagle.updateMatrix();

	var alien = new SWE.SceneObject('resources/my_shader2.fs', alienMesh);
	scene.add(alien);
	alien.applyMatrix(getTransform([-50, 0, 0], [-1.6, 1, 0, 0], [50, 50, 50]));
	alien.updateMatrix();

	var avatar = new SWE.SceneObject('resources/my_shader2.fs', avatarMesh);
	scene.add(avatar);
	avatar.applyMatrix(getTransform([50, -50, 0], [-1.6, 1, 0, 0], [50, 50, 50]));
	avatar.updateMatrix();

	// var gonObj = new SWE.SceneObject('resources/my_shader2.fs', gonMesh);
	// scene.add(gonObj);
	// gonObj.applyMatrix(getTransform([-150, 0, 0], [0, 1, 0, 0], [10, 10, 10]));
	// gonObj.updateMatrix();

	var cameraNode = new SWE.Camera;
	scene.add(cameraNode);
	cameraNode.setPerspective(3.14 / 180 * 60, canvas.width / canvas.height, 0.1, 1000);
	cameraNode.applyMatrix(getTransform([0, 0, -505], [0, 1, 0, 0], [1, 1, 1]));
	cameraNode.updateMatrix();

	// gl.clear(gl.COLOR_BUFFER_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	gl.viewport(0, 0, canvas.width, canvas.height);

	cycle(Date.now());

	var prevTime;
	var prevX, curX;
	function cycle(time) {
		buttonListener.update();
		webkitRequestAnimationFrame(cycle);

		gl.clear(gl.COLOR_BUFFER_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		// // gl.viewport(0, 0, canvas.width, canvas.height);

		scene.updateMatrixWorld();
		scene.draw(cameraNode, time / 1000);

		if (prevX) {
			if (curX - prevX != 0) {
				var out = mat4.create();
				mat4.rotateY(out, out, (curX - prevX) / 100);
				mat4.multiply(cameraNode.matrix, out, cameraNode.matrix);
				cameraNode.applyMatrix(cameraNode.matrix);
				cameraNode.updateMatrix();
				// cameraNode.matrixWorldInvalidated = true;
				// cameraNode.updateMatrix();
				// console.log(curX - prevX);
			}
		}
		prevX = curX;
	}


	function mainCtrl($scope, buttonlistener) {

		$scope.callbacks= {};
		$scope.callbacks['A'.charCodeAt(0)] = {
			callback : function() {
				cameraNode.position[0] += 2;
				cameraNode.updateMatrix();
			},
			priority : 100
		};
		$scope.callbacks['S'.charCodeAt(0)] = {
			callback : function() {
				cameraNode.position[2] -= 2;
				cameraNode.updateMatrix();
			},
			priority : 100
		};
		$scope.callbacks['D'.charCodeAt(0)] = {
			callback : function() {
				cameraNode.position[0] -= 2;
				cameraNode.updateMatrix();
			},
			priority : 100
		};
		$scope.callbacks['W'.charCodeAt(0)] = {
			callback : function() {
				cameraNode.position[2] += 2;
				cameraNode.updateMatrix();
			},
			priority : 100
		};
		buttonlistener.addScopeListeners($scope);

		$scope.triggerAnimation = function() {
			alien.triggerAnimation(alienAni, Date.now() / 1000);
			// eagle.triggerAnimation(eagleAni, Date.now() / 1000);
			avatar.triggerAnimation(avatarAni, Date.now() / 1000);
		}

		$scope.handleMouseMove = function(e) {
			if (e.button == 2) {
				curX = e.pageX;
			} else {
				prevX = curX = e.pageX;
			}
		}

		$scope.mousedown = function(e) {
			// if (e.button == 2) {
			// 	prevX = e.pageX;
			// }
		}
	}

	$(document).bind('keyup.global', function COMMONJS(e) {	
		buttonListener.keyUp(e);
		if(e.keyCode == 9) return false;
	});

	$(document).bind('keydown.global', function COMMONJS(e) {	
		keyListener.post(e.keyCode, e);
		buttonListener.keyDown(e);
	});

	document.addEventListener( 'contextmenu', function ( event ) { event.preventDefault(); }, false );

	angular.module('WebGLEngine',[])
	.factory('keylistener', function() {
		"use strict";
		return {
			addScopeListeners : function(scope) {
				if (scope.callbacks) {
					$.each(scope.callbacks, function(k, v) {
						keyListener.addListener(k, scope);
					});
					scope.$on('$destroy', function () {
						keyListener.removeListener(scope);
					});
				}
			},
			removeScopeListeners : function( scope ) {
				if (scope.callbacks) {
					keyListener.removeListener(scope);
				}
			}
		};
	})
	.factory('buttonlistener', function() {
		"use strict";
		return {
			addScopeListeners : function(scope) {
				if (scope.callbacks) {
					$.each(scope.callbacks, function(k, v) {
						buttonListener.addListener(k, scope);
					});
					scope.$on('$destroy', function () {
						buttonListener.removeListener(scope);
					});
				}
			},
			removeScopeListeners : function( scope ) {
				if (scope.callbacks) {
					buttonListener.removeListener(scope);
				}
			}
		};
	});

</script>

</div>

</html>
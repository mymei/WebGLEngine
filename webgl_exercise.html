<html ng-app='WebGLEngine'>

<script type="text/javascript" src="lib/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="lib/gl-matrix.js"></script>
<script type="text/javascript" src="lib/webgl-debug.js"></script>
<script type="text/javascript" src="lib/xml2json.js"></script>
<script type="text/javascript" src="lib/msgpack.js"></script>
<script type="text/javascript" src="lib/angular.min.js"></script>

<script type="text/javascript" src="src/common/SWE_base.js"></script>
<script type="text/javascript" src="src/common/serialization.js"></script>
<script type="text/javascript" src="src/common/keyListener.js"></script>
<script type="text/javascript" src="src/common/buttonListener.js"></script>

<script type="text/javascript" src="src/collada_parser/common.js"></script>
<script type="text/javascript" src="src/collada_parser/scene.js"></script>
<script type="text/javascript" src="src/collada_parser/animation.js"></script>
<script type="text/javascript" src="src/collada_parser/skin.js"></script>
<script type="text/javascript" src="src/collada_parser/geometry.js"></script>
<script type="text/javascript" src="src/collada_parser/mesh.js"></script>
<script type="text/javascript" src="src/collada_parser/polygon.js"></script>
<script type="text/javascript" src="src/collada_parser/meshdata.js"></script>
<script type="text/javascript" src="src/collada_parser/buffer.js"></script>
<script type="text/javascript" src="src/collada_parser/controller.js"></script>
<script type="text/javascript" src="src/collada_parser/asset.js"></script>

<script type="text/javascript" src="src/webgl/webgl_core.js"></script>
<script type="text/javascript" src="src/webgl/drawingelement.js"></script>
<script type="text/javascript" src="src/webgl/colladaelement.js"></script>
<script type="text/javascript" src="src/webgl/planeelement.js"></script>
<script type="text/javascript" src="src/webgl/primitive.js"></script>

<script type="text/javascript" src="src/scene/sceneNode.js"></script>
<script type="text/javascript" src="src/scene/sceneCamera.js"></script>
<script type="text/javascript" src="src/scene/sceneObject.js"></script>

<div ng-controller="mainCtrl">

<canvas id="canvas" width='400' height='300' style="background-color:rgba(0, 0, 0, 0.5)" ng-click="triggerAnimation()" ng-mousemove="handleMouseMove($event)" ng-mousedown="mousedown($event)"></canvas>

<script type="text/javascript">

	var canvas = document.getElementById("canvas"), gl = canvas.getContext('experimental-webgl');

	gl.clearColor(0.15, 0.15, 1, 0.5);
	gl.enable(gl.DEPTH_TEST);


	// var eagleMesh = createPackedObject('./eagle.mbf');
	var alienMesh = createPackedBinary('./alien.mbf');
	var gonMesh = createPackedBinary('./gon.mbf');
	var avatarMesh = createPackedBinary('./avatar.mbf');

	// var eagleAni = createPackedObject('./eagle.ani');
	var alienAni = createPackedBinary('./alien.ani');
	var avatarAni = createPackedBinary('./avatar.ani');

	var scene = new SWE.Node;

	// var eagle = new SWE.SceneObject('resources/my_shader2.fs', eagleMesh);
	// scene.add(eagle);
	// vec3.set(eagle.position, 150, 0, 0);
	// eagle.updateMatrix();

	var alien = new SWE.SceneObject('resources/my_shader2.fs', alienMesh);
	scene.add(alien);
	alien.applyMatrix(getTransform([-50, 0, 0], [-1.6, 1, 0, 0], [50, 50, 50]));
	alien.updateMatrix();

	var gonObj = new SWE.SceneObject('resources/my_shader2.fs', gonMesh);
	scene.add(gonObj);
	gonObj.applyMatrix(getTransform([-150, 0, 0], [0, 1, 0, 0], [10, 10, 10]));
	gonObj.updateMatrix();

	var cameraNode = new SWE.Camera;
	scene.add(cameraNode);
	cameraNode.setPerspective(3.14 / 180 * 60, canvas.width / canvas.height, 0.1, 1000);
	cameraNode.applyMatrix(getTransform([0, 0, 505], [0, 1, 0, 0], [1, 1, 1]));
	cameraNode.updateMatrix();

	var avatar = new SWE.SceneObject('resources/my_shader2.fs', avatarMesh);
	cameraNode.add(avatar);
	avatar.applyMatrix(getTransform([0, -1, -2], [-1.6, 1, 0, 0], [1, 1, 1]));
	quat.rotateZ(avatar.quaternion, avatar.quaternion, 3.14);
	avatar.updateMatrix();

	// gl.clear(gl.COLOR_BUFFER_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	gl.viewport(0, 0, canvas.width, canvas.height);

	cycle(Date.now());

	var prevTime;
	var prevX, prevY, curX, curY;
	var pitch = 0; yaw = 0;
	var modified = false;

	function cycle(time) {
		buttonListener.update();
		webkitRequestAnimationFrame(cycle);

		gl.clear(gl.COLOR_BUFFER_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		// // gl.viewport(0, 0, canvas.width, canvas.height);

		scene.updateMatrixWorld();
		scene.draw(cameraNode, time / 1000);

		if (prevX && prevY) {
			if (prevX - curX != 0) {
				yaw += (prevX - curX) / 100;
				modified = true;
			}
			if (prevY - curY != 0) {
				pitch += (prevY - curY) / 100;
				modified = true;
			}

			if (modified) {
				quat.identity(cameraNode.quaternion);
				quat.rotateY(cameraNode.quaternion, cameraNode.quaternion, yaw);
				quat.rotateX(cameraNode.quaternion, cameraNode.quaternion, pitch);
				cameraNode.updateMatrix();
				modified = false;
			}

			prevX = curX;
			prevY = curY;
		}
	}


	function mainCtrl($scope, buttonlistener) {

		function cameraMove(dir) {
			var length = vec3.length(dir);
			vec3.transformQuat(dir, dir, cameraNode.quaternion);
			dir[1] = 0;
			vec3.normalize(dir, dir);
			vec3.scale(dir, dir, length);
			vec3.add(cameraNode.position, cameraNode.position, dir);
			cameraNode.updateMatrix();
		}

		$scope.callbacks= {};
		$scope.callbacks['A'.charCodeAt(0)] = {
			callback : function() {
				cameraMove(vec3.fromValues(-2, 0, 0));
			},
			priority : 100
		};
		$scope.callbacks['S'.charCodeAt(0)] = {
			callback : function() {
				cameraMove(vec3.fromValues(0, 0, 2));
			},
			priority : 100
		};
		$scope.callbacks['D'.charCodeAt(0)] = {
			callback : function() {
				cameraMove(vec3.fromValues(2, 0, 0));
			},
			priority : 100
		};
		$scope.callbacks['W'.charCodeAt(0)] = {
			callback : function() {
				cameraMove(vec3.fromValues(0, 0, -2));
			},
			priority : 100
		};
		buttonlistener.addScopeListeners($scope);

		$scope.triggerAnimation = function() {
			alien.triggerAnimation(alienAni, Date.now() / 1000);
			// eagle.triggerAnimation(eagleAni, Date.now() / 1000);
			avatar.triggerAnimation(avatarAni, Date.now() / 1000);
		}

		$scope.handleMouseMove = function(e) {
			if (e.button == 2) {
				curX = e.pageX;
				curY = e.pageY;
			} else {
				prevX = curX = e.pageX;
				prevY = curY = e.pageY;
			}
		}

		$scope.mousedown = function(e) {
			// if (e.button == 2) {
			// 	prevX = e.pageX;
			// }
		}
	}

	$(document).bind('keyup.global', function COMMONJS(e) {	
		buttonListener.keyUp(e);
		if(e.keyCode == 9) return false;
	});

	$(document).bind('keydown.global', function COMMONJS(e) {	
		keyListener.post(e.keyCode, e);
		buttonListener.keyDown(e);
	});

	document.addEventListener( 'contextmenu', function ( event ) { event.preventDefault(); }, false );

	angular.module('WebGLEngine',[])
	.factory('keylistener', function() {
		"use strict";
		return {
			addScopeListeners : function(scope) {
				if (scope.callbacks) {
					$.each(scope.callbacks, function(k, v) {
						keyListener.addListener(k, scope);
					});
					scope.$on('$destroy', function () {
						keyListener.removeListener(scope);
					});
				}
			},
			removeScopeListeners : function( scope ) {
				if (scope.callbacks) {
					keyListener.removeListener(scope);
				}
			}
		};
	})
	.factory('buttonlistener', function() {
		"use strict";
		return {
			addScopeListeners : function(scope) {
				if (scope.callbacks) {
					$.each(scope.callbacks, function(k, v) {
						buttonListener.addListener(k, scope);
					});
					scope.$on('$destroy', function () {
						buttonListener.removeListener(scope);
					});
				}
			},
			removeScopeListeners : function( scope ) {
				if (scope.callbacks) {
					buttonListener.removeListener(scope);
				}
			}
		};
	});

</script>

</div>

</html>